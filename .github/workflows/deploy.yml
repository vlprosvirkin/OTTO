name: Deploy OTTO Agent

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      reason:
        description: "Reason for manual deploy"
        required: false
        default: "manual"

concurrency:
  group: deploy
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy to GCP via SSH
    runs-on: ubuntu-latest

    # Only the repo owner can trigger this pipeline
    if: github.actor == 'vlprosvirkin'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.GCP_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.GCP_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

      - name: Deploy
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.GCP_USER }}@${{ secrets.GCP_HOST }} << 'ENDSSH'
            set -euo pipefail
            OTTO="$HOME/OTTO"

            echo "→ git pull"
            git -C "$OTTO" pull --ff-only

            echo "→ npm install mcp"
            npm install --prefix "$OTTO/mcp" --prefer-offline 2>&1 | tail -2

            echo "→ npm install agent"
            npm install --prefix "$OTTO/agent" --prefer-offline 2>&1 | tail -2

            echo "→ npm install demo-server"
            npm install --prefix "$OTTO/demo-server" --prefer-offline 2>&1 | tail -2

            echo "→ sync workspace files"
            WS="$HOME/.openclaw/workspace"
            mkdir -p "$WS"
            for f in AGENTS.md SOUL.md IDENTITY.md TOOLS.md USER.md HEARTBEAT.md; do
              [ -f "$OTTO/agent/$f" ] && cp "$OTTO/agent/$f" "$WS/$f"
            done
            rm -f "$WS/BOOTSTRAP.md"

            # Symlink project dirs so OpenClaw finds skills, scripts, agent.md
            ln -sfn "$OTTO/agent/skills" "$WS/skills"
            ln -sfn "$OTTO/agent/scripts" "$WS/scripts"
            ln -sfn "$OTTO/agent/agent.md" "$WS/agent.md"
            echo "  Workspace synced"

            echo "→ restart openclaw"
            pkill -f "openclaw" 2>/dev/null && sleep 2 || true

            set -a
            source "$OTTO/agent/.env"
            set +a
            export ANTHROPIC_API_KEY="${ANTHROPIC_API_KEY:-$CLAUDE_API_KEY}"

            echo "→ ensure openclaw config"
            npx --prefix "$OTTO/agent" openclaw config set gateway.mode local 2>/dev/null || true
            npx --prefix "$OTTO/agent" openclaw config set gateway.auth.mode token 2>/dev/null || true
            npx --prefix "$OTTO/agent" openclaw config set gateway.auth.token otto-demo-gw-2026 2>/dev/null || true
            npx --prefix "$OTTO/agent" openclaw config set gateway.controlUi.allowedOrigins '["https://ottoarc.xyz"]' 2>/dev/null || true
            npx --prefix "$OTTO/agent" openclaw config set gateway.controlUi.dangerouslyDisableDeviceAuth true 2>/dev/null || true
            npx --prefix "$OTTO/agent" openclaw config set gateway.controlUi.allowInsecureAuth true 2>/dev/null || true

            echo "→ configure trusted proxy (Caddy)"
            npx --prefix "$OTTO/agent" openclaw config set gateway.trustedProxies '["127.0.0.1","::1"]' 2>/dev/null || true

            echo "→ configure telegram channel"
            npx --prefix "$OTTO/agent" openclaw config set channels.telegram.enabled true 2>/dev/null || true
            npx --prefix "$OTTO/agent" openclaw config set channels.telegram.dmPolicy open 2>/dev/null || true
            npx --prefix "$OTTO/agent" openclaw config set channels.telegram.allowFrom '["*"]' 2>/dev/null || true
            npx --prefix "$OTTO/agent" openclaw config set channels.telegram.groups '{"*":{"requireMention":true}}' 2>/dev/null || true

            npx --prefix "$OTTO/agent" openclaw doctor --fix 2>/dev/null || true

            nohup npx --prefix "$OTTO/agent" openclaw gateway run \
              >> "$HOME/otto.log" 2>&1 &
            echo "  Gateway PID: $!"

            echo "→ restart demo-server"
            fuser -k 4402/tcp 2>/dev/null && sleep 1 || true
            cd "$OTTO/demo-server"
            nohup npx tsx server.ts >> "$HOME/otto-demo.log" 2>&1 &
            echo "  Demo-server PID: $!"
            cd "$OTTO"

            echo "→ setup caddy reverse proxy"
            if ! command -v caddy &>/dev/null; then
              sudo apt-get update -qq && sudo apt-get install -y -qq caddy
            fi
            sudo cp "$OTTO/Caddyfile" /etc/caddy/Caddyfile
            sudo systemctl reload caddy || sudo systemctl restart caddy
            echo "  Caddy OK"
          ENDSSH

      - name: Smoke test
        run: |
          sleep 6
          ssh -i ~/.ssh/deploy_key ${{ secrets.GCP_USER }}@${{ secrets.GCP_HOST }} << 'ENDSSH'
            echo "→ gateway log (last 30 lines):"
            tail -30 ~/otto.log 2>/dev/null || echo "(no log)"
            echo ""
            echo "→ gateway process check:"
            pgrep -fa "openclaw" || echo "WARNING: no openclaw process found!"
            echo ""
            echo "→ smoke test:"
            cd ~/OTTO/agent && source .env
            npx tsx scripts/invoke.ts rebalance_check '{"min_usdc":1}' 2>/dev/null \
              | grep -q 'threshold_usdc' && echo '✓ Agent healthy' || (echo '✗ Smoke test failed' && exit 1)
          ENDSSH

      - name: Notify success
        if: success()
        run: |
          MSG="✅ OTTO deployed%0Acommit: ${{ github.sha }}%0Aserver: ${{ secrets.GCP_HOST }}"
          curl -s "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_ADMIN_CHAT_ID }}" -d "text=$MSG" > /dev/null

      - name: Notify failure
        if: failure()
        run: |
          MSG="❌ OTTO deploy FAILED%0Acommit: ${{ github.sha }}"
          curl -s "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_ADMIN_CHAT_ID }}" -d "text=$MSG" > /dev/null
